<!DOCTYPE html>
<html>
<style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root { --room-hallway-name-font-size: 25px; --room-hallway-character-font-size: 20px; --cell-size: calc(10 * var(--room-hallway-character-font-size)); }
    body { margin: 0; padding: 0; height: auto; display: block; overflow-y: auto; font-family: Arial, sans-serif; }
    #notification { padding: 2px; max-height: 200px; overflow-y: auto; }
    #game-board { display: grid; grid-template-columns: repeat(5, var(--cell-size)); grid-template-rows: repeat(5, var(--cell-size)); gap: 5px; background-color: #fff; padding: 10px; border: 2px solid #000; margin: 0 auto; max-width: fit-content; }
    .room, .hallway, .vacant { width: var(--cell-size); height: var(--cell-size); border: 2px solid #000; text-align: center; position: relative; box-sizing: border-box; cursor: pointer; }
    .room:hover, .hallway:hover { background-color: #e0e0e0; }
    .room-characters span, .hallway-characters span { white-space: nowrap; display: block; font-weight: bold; }
    .room { background-color: lightpink; }
    .room-name { font-size: var(--room-hallway-name-font-size); font-weight: bold; padding: 5px 0; background-color: hotpink; }
    .room-characters { font-size: var(--room-hallway-character-font-size); padding: 2px; overflow-y: auto; white-space: pre-line; max-height: calc(var(--cell-size) - 40px); }
    .hallway { background-color: lightcyan; }
    .hallway-name { font-size: var(--room-hallway-name-font-size); font-weight: bold; padding: 5px 0; background-color: lightskyblue; }
    .hallway-characters { font-size: var(--room-hallway-character-font-size); padding: 2px; overflow-y: auto; white-space: pre-line; max-height: calc(var(--cell-size) - 40px); }
    .vacant { background-color: white; }
    @keyframes fadeMove { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
    .fade-move { animation: fadeMove 0.5s ease-in-out; }
</style>
<body>
    <div id="notification">
        <h1>Welcome to Clue-Less Game {{ game_id }}</h1>
        <p>You are logged in as {{ request.user.username }}. <button onclick="window.location.href='{% url 'logout' %}'">Logout</button></p>
        <div id="game-state"></div>
    </div>

    <div id="game-board">
        <div id="Study" class="room"><div class="room-name">Study</div><div class="room-characters" id="Study-characters"></div></div>
        <div id="Hallway1" class="hallway"><div class="hallway-name">Hallway1</div><div class="hallway-characters" id="Hallway1-characters"></div></div>
        <div id="Hall" class="room"><div class="room-name">Hall</div><div class="room-characters" id="Hall-characters"></div></div>
        <div id="Hallway2" class="hallway"><div class="hallway-name">Hallway2</div><div class="hallway-characters" id="Hallway2-characters"></div></div>
        <div id="Lounge" class="room"><div class="room-name">Lounge</div><div class="room-characters" id="Lounge-characters"></div></div>

        <div id="Hallway3" class="hallway"><div class="hallway-name">Hallway3</div><div class="hallway-characters" id="Hallway3-characters"></div></div>
        <div id="Vacant1" class="vacant"></div>
        <div id="Hallway4" class="hallway"><div class="hallway-name">Hallway4</div><div class="hallway-characters" id="Hallway4-characters"></div></div>
        <div id="Vacant2" class="vacant"></div>
        <div id="Hallway5" class="hallway"><div class="hallway-name">Hallway5</div><div class="hallway-characters" id="Hallway5-characters"></div></div>

        <div id="Library" class="room"><div class="room-name">Library</div><div class="room-characters" id="Library-characters"></div></div>
        <div id="Hallway6" class="hallway"><div class="hallway-name">Hallway6</div><div class="hallway-characters" id="Hallway6-characters"></div></div>
        <div id="BilliardRoom" class="room"><div class="room-name">Billiard Room</div><div class="room-characters" id="BilliardRoom-characters"></div></div>
        <div id="Hallway7" class="hallway"><div class="hallway-name">Hallway7</div><div class="hallway-characters" id="Hallway7-characters"></div></div>
        <div id="DiningRoom" class="room"><div class="room-name">Dining Room</div><div class="room-characters" id="DiningRoom-characters"></div></div>

        <div id="Hallway8" class="hallway"><div class="hallway-name">Hallway8</div><div class="hallway-characters" id="Hallway8-characters"></div></div>
        <div id="Vacant3" class="vacant"></div>
        <div id="Hallway9" class="hallway"><div class="hallway-name">Hallway9</div><div class="hallway-characters" id="Hallway9-characters"></div></div>
        <div id="Vacant4" class="vacant"></div>
        <div id="Hallway10" class="hallway"><div class="hallway-name">Hallway10</div><div class="hallway-characters" id="Hallway10-characters"></div></div>

        <div id="Conservatory" class="room"><div class="room-name">Conservatory</div><div class="room-characters" id="Conservatory-characters"></div></div>
        <div id="Hallway11" class="hallway"><div class="hallway-name">Hallway11</div><div class="hallway-characters" id="Hallway11-characters"></div></div>
        <div id="Ballroom" class="room"><div class="room-name">Ballroom</div><div class="room-characters" id="Ballroom-characters"></div></div>
        <div id="Hallway12" class="hallway"><div class="hallway-name">Hallway12</div><div class="hallway-characters" id="Hallway12-characters"></div></div>
        <div id="Kitchen" class="room"><div class="room-name">Kitchen</div><div class="room-characters" id="Kitchen-characters"></div></div>
    </div>

    {{ players|json_script:"players-data" }}
    {% if request.user.is_authenticated %}
        {{ request.user.username|json_script:"current-username" }}
    {% endif %}

    <script>
    const gameId = {{ game_id }};
    const ws = new WebSocket(`ws://localhost:8000/ws/game/${gameId}/`);

    const playersDataElement = document.getElementById('players-data');
    const playersData = playersDataElement ? JSON.parse(playersDataElement.textContent) : [];
    const currentUsernameElement = document.getElementById('current-username');
    const currentUsername = currentUsernameElement ? JSON.parse(currentUsernameElement.textContent) : '';

    let currentPlayer = null;

    ws.onopen = function() {
        console.log("WebSocket connected successfully");
    };

    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log('Received WebSocket message:', data);
        if (data.type === 'game_update') {
            updateGameBoard(data.game_state);
        } else if (data.error) {
            console.error('Error:', data.error);
            alert(data.error);
        }
    };

    ws.onerror = function(error) {
        console.error("WebSocket connection error:", error);
    };

    ws.onclose = function() {
        console.log("WebSocket closed");
    };

    function updateGameBoard(gameState) {
        console.log('Updating game board with state:', gameState);  // Debug log
        const players = gameState.players || [];
        console.log('Players array:', players);  // Debug log
        updateRoomCharacters(players);
        updateHallwayCharacters(players);
        currentPlayer = players.find(player => player.username === currentUsername) || null;
    }

    function updateRoomCharacters(players) {
        const rooms = ['Study', 'Hall', 'Lounge', 'Library', 'BilliardRoom', 'DiningRoom', 'Conservatory', 'Ballroom', 'Kitchen'];
        rooms.forEach(roomId => {
            const charElement = document.getElementById(`${roomId}-characters`);
            if (charElement) {
                const charactersInRoom = players
                    .filter(player => {
                        const match = player.location === roomId && player.is_active;
                        console.log(`Checking ${roomId} for ${player.username}: Location=${player.location}, Active=${player.is_active}, Match=${match}`);
                        return match;
                    })
                    .map(player => `<span>${player.character}</span>`)
                    .join('');
                charElement.innerHTML = charactersInRoom || '';
                console.log(`Updated ${roomId} characters: ${charactersInRoom}`);
            }
        });
    }

    function updateHallwayCharacters(players) {
        const hallways = ['Hallway1', 'Hallway2', 'Hallway3', 'Hallway4', 'Hallway5', 'Hallway6', 'Hallway7', 'Hallway8', 'Hallway9', 'Hallway10', 'Hallway11', 'Hallway12'];
        hallways.forEach(hallwayId => {
            const charElement = document.getElementById(`${hallwayId}-characters`);
            if (charElement) {
                const charactersInHallway = players
                    .filter(player => {
                        const match = player.location === hallwayId && player.is_active;
                        console.log(`Checking ${hallwayId} for ${player.username}: Location=${player.location}, Active=${player.is_active}, Match=${match}`);
                        return match;
                    })
                    .map(player => `<span>${player.character}</span>`)
                    .join('');
                charElement.innerHTML = charactersInHallway || '';
                console.log(`Updated ${hallwayId} characters: ${charactersInHallway}`);
            }
        });
}

    function addClickListeners() {
        const rooms = document.querySelectorAll('.room');
        const hallways = document.querySelectorAll('.hallway');
        const clickableElements = [...rooms, ...hallways];

        clickableElements.forEach(element => {
            element.addEventListener('click', () => {
                const location = element.id;
                if (currentPlayer) {
                    const message = JSON.stringify({
                        'type': 'move',
                        'location': location
                    });
                    console.log('Sending move:', message);
                    ws.send(message);
                } else {
                    console.log('No current player defined');
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('Initial players data:', playersData);  // Debug log
        updateGameBoard({ players: playersData });  // Initial update
        addClickListeners();
    });
    </script>
</body>
</html>