<!DOCTYPE html>
<html>
    <style>
        /* Global reset for consistent sizing */
        * { box-sizing: border-box; margin: 0; padding: 0; }
    
        /* Define CSS variables for board sizing */
        :root {
            --cell-size: min(18vw, 18vh);  /* Auto scales with window size */
            --room-hallway-name-font-size: calc(var(--cell-size) * 0.15); 
            --room-hallway-character-font-size: calc(var(--cell-size) * 0.12);
        }
    
        /* Basic body styling */
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            overflow: hidden;
            text-align: center; /* Ensures text is centered */
        }
    
        /* Notification area styling */
        #notification {
            padding: 10px;
            text-align: center;
            max-width: 90%;
            background: white;
            border-bottom: 2px solid black;
            width: 100%;
        }
    
        /* Game board grid layout */
        #game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 2px;
            background-color: rgb(0, 0, 0);
            padding: 10px;
            border: 5px solid black;
            width: 90vmin;
            height: 90vmin;
            margin: auto; /* Ensures it remains centered */
        }
    
        /* Common styling for rooms, hallways, and vacant cells */
        .room, .hallway, .vacant {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-sizing: border-box;
            width: 100%;
            height: 100%;
            position: relative;
        }
    
        /* Room-specific styling */
        .room {
            background-color: lightpink;
            color: black;
        }

    /* Hover effect for interactivity */
    .room:hover, .hallway:hover { background-color: #e0e0e0; }

    /* Character name styling */
    .room-characters span, .hallway-characters span {
        white-space: nowrap;
        display: block;
            font-weight: bold;
            background-color: transparent;
            padding: 5px;
            width: 100%;
            text-align: center;
        }
        .hallway-characters {
            font-size: var(--room-hallway-character-font-size);
            padding: 2px;
            text-align: center;
            min-height: 20%;
        }
    
        /* Vacant cell styling */
        .vacant {
            background-color: white;
        }
    
        /* Player-specific styling */
    .player-me { color: red; }      /* My player in red */
    .player-other { color: blue; }  /* Other players in blue */

    /* Room-specific styling */
    .room { background-color: rgb(254, 204, 212); }
    .room-name { font-size: var(--room-hallway-name-font-size); font-weight: bold; padding: 5px 0; }
    .room-characters { font-size: var(--room-hallway-character-font-size); padding: 2px; overflow-y: auto; white-space: pre-line; max-height: calc(var(--cell-size) - 40px); }

    /* Hallway-specific styling */
    .hallway { background-color: rgb(196, 233, 245); }
    .hallway-name { font-size: var(--room-hallway-name-font-size); font-weight: bold; padding: 5px 0;}
    .hallway-characters { font-size: var(--room-hallway-character-font-size); padding: 2px; overflow-y: auto; white-space: pre-line; max-height: calc(var(--cell-size) - 40px); }

    /* Vacant cell styling */
    .vacant { background-color: white; }
    
        /* Animation for character movement */
        @keyframes pulseMove {
            0% { transform: scale(1); }
        50% { transform: scale(1.7); }
            100% { transform: scale(1); }
        }
        .pulse-move {
            animation: pulseMove 0.5s ease-in-out;
        }
    
        /* Responsive resizing */
        @media (max-width: 600px) {
            :root {
                --cell-size: min(18vw, 18vh);
            }
        }
    </style>
    
<body>
    <!-- Notification section: Displays welcome message and logout button -->
    <div id="notification">
        <h1>Welcome to Clue-Less Game {{ game_id }}</h1> <!-- Game ID from template -->
        <h2>You are logged in as Username: {{ username }} as Character: {{ character }}.
            <button onclick="window.location.href='{% url 'logout' %}'">Logout</button></h2> <!-- Current user and logout button -->
        <div id="game-state"></div> <!-- Placeholder for future game state display -->
    </div>

    <!-- Game board: 5x5 grid layout for rooms, hallways, and vacant spaces -->
    <div id="game-board">
        <!-- Row 1 -->
        <div id="Study" class="room"><div class="room-name">Study</div><div class="room-characters" id="Study-characters"></div></div> <!-- Room with name and character area -->
        <div id="Hallway1" class="hallway"><div class="hallway-name">Hallway1</div><div class="hallway-characters" id="Hallway1-characters"></div></div> <!-- Hallway connecting Study and Hall -->
        <div id="Hall" class="room"><div class="room-name">Hall</div><div class="room-characters" id="Hall-characters"></div></div>
        <div id="Hallway2" class="hallway"><div class="hallway-name">Hallway2</div><div class="hallway-characters" id="Hallway2-characters"></div></div> <!-- Hallway connecting Hall and Lounge -->
        <div id="Lounge" class="room"><div class="room-name">Lounge</div><div class="room-characters" id="Lounge-characters"></div></div>

        <!-- Row 2 -->
        <div id="Hallway3" class="hallway"><div class="hallway-name">Hallway3</div><div class="hallway-characters" id="Hallway3-characters"></div></div> <!-- Hallway connecting Study and Library -->
        <div id="Vacant1" class="vacant"></div> <!-- Empty space -->
        <div id="Hallway4" class="hallway"><div class="hallway-name">Hallway4</div><div class="hallway-characters" id="Hallway4-characters"></div></div> <!-- Hallway connecting Hall and Billiard Room -->
        <div id="Vacant2" class="vacant"></div>
        <div id="Hallway5" class="hallway"><div class="hallway-name">Hallway5</div><div class="hallway-characters" id="Hallway5-characters"></div></div> <!-- Hallway connecting Lounge and Dining Room -->

        <!-- Row 3 -->
        <div id="Library" class="room"><div class="room-name">Library</div><div class="room-characters" id="Library-characters"></div></div>
        <div id="Hallway6" class="hallway"><div class="hallway-name">Hallway6</div><div class="hallway-characters" id="Hallway6-characters"></div></div> <!-- Hallway connecting Library and Billiard Room -->
        <div id="BilliardRoom" class="room"><div class="room-name">Billiard Room</div><div class="room-characters" id="BilliardRoom-characters"></div></div>
        <div id="Hallway7" class="hallway"><div class="hallway-name">Hallway7</div><div class="hallway-characters" id="Hallway7-characters"></div></div> <!-- Hallway connecting Billiard Room and Dining Room -->
        <div id="DiningRoom" class="room"><div class="room-name">Dining Room</div><div class="room-characters" id="DiningRoom-characters"></div></div>

        <!-- Row 4 -->
        <div id="Hallway8" class="hallway"><div class="hallway-name">Hallway8</div><div class="hallway-characters" id="Hallway8-characters"></div></div> <!-- Hallway connecting Library and Conservatory -->
        <div id="Vacant3" class="vacant"></div>
        <div id="Hallway9" class="hallway"><div class="hallway-name">Hallway9</div><div class="hallway-characters" id="Hallway9-characters"></div></div> <!-- Hallway connecting Billiard Room and Ballroom -->
        <div id="Vacant4" class="vacant"></div>
        <div id="Hallway10" class="hallway"><div class="hallway-name">Hallway10</div><div class="hallway-characters" id="Hallway10-characters"></div></div> <!-- Hallway connecting Dining Room and Kitchen -->

        <!-- Row 5 -->
        <div id="Conservatory" class="room"><div class="room-name">Conservatory</div><div class="room-characters" id="Conservatory-characters"></div></div>
        <div id="Hallway11" class="hallway"><div class="hallway-name">Hallway11</div><div class="hallway-characters" id="Hallway11-characters"></div></div> <!-- Hallway connecting Conservatory and Ballroom -->
        <div id="Ballroom" class="room"><div class="room-name">Ballroom</div><div class="room-characters" id="Ballroom-characters"></div></div>
        <div id="Hallway12" class="hallway"><div class="hallway-name">Hallway12</div><div class="hallway-characters" id="Hallway12-characters"></div></div> <!-- Hallway connecting Ballroom and Kitchen -->
        <div id="Kitchen" class="room"><div class="room-name">Kitchen</div><div class="room-characters" id="Kitchen-characters"></div></div>
    </div>

    <!-- Serialize initial players data from views.py for JavaScript use -->
    {{ players|json_script:"players-data" }}
    {% if request.user.is_authenticated %}
        <!-- Serialize current username if authenticated, used to identify the current player -->
        {{ request.user.username|json_script:"current-username" }}
    {% endif %}

    <script>
    // Set up WebSocket connection using the game_id passed from the template
    const gameId = {{ game_id }};
    const ws = new WebSocket('ws://' + window.location.host + '/ws/game/' + gameId + '/');

    // Retrieve initial players data from the DOM, fallback to empty array if not found
    const playersDataElement = document.getElementById('players-data');
    const playersData = playersDataElement ? JSON.parse(playersDataElement.textContent) : [];

    // Retrieve current username from the DOM and lock it for this session
    const currentUsernameElement = document.getElementById('current-username');
    const currentUsername = currentUsernameElement ? JSON.parse(currentUsernameElement.textContent) : '';

    let currentPlayer = null; // Store the current player's data for move validation
    let previousGameState = null; // Store the previous game state to detect movement

    // Log when the WebSocket connection is established
    ws.onopen = function() {
        console.log("WebSocket connected successfully");
    };

    // Handle incoming WebSocket messages from the server
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data); // Parse JSON data from the message
        console.log('Received WebSocket message:', data); // Debug log for received messages
        if (data.type === 'game_update') {
            updateGameBoard(data.game_state); // Update the board with the new game state
        } else if (data.error) {
            console.error('Error:', data.error); // Log any errors
            alert(data.error); // Notify the user of errors (e.g., invalid move)
        }
    };

    // Log any WebSocket connection errors
    ws.onerror = function(error) {
        console.error("WebSocket connection error:", error);
    };

    // Log when the WebSocket connection closes
    ws.onclose = function() {
        console.log("WebSocket closed");
    };

    // Update the game board with the provided game state
    function updateGameBoard(gameState) {
        console.log('Updating game board with state:', gameState); // Debug log for game state
        const players = gameState.players || []; // Extract players array, default to empty if missing
        console.log('Players array:', players); // Debug log for players array

        // Determine which player moved by comparing with previous state
        let movedPlayer = null;
        if (previousGameState) {
            const prevPlayers = previousGameState.players || [];
            movedPlayer = players.find(player => {
                const prevPlayer = prevPlayers.find(p => p.username === player.username);
                return prevPlayer && prevPlayer.location !== player.location;
            })?.username;
        }

        updateRoomCharacters(players, movedPlayer); // Update room displays with all players
        updateHallwayCharacters(players, movedPlayer); // Update hallway displays with all players
        // Set currentPlayer for movement logic only, no character display update
        currentPlayer = players.find(player => player.username === currentUsername) || null;

        // Update previous state for the next comparison
        previousGameState = JSON.parse(JSON.stringify(gameState)); // Deep copy
    }

    // Update room characters with animation only for the moved player,
    // showing all players regardless of is_active
    function updateRoomCharacters(players, movedPlayer) {
        const rooms = ['Study', 'Hall', 'Lounge', 'Library', 'BilliardRoom', 'DiningRoom', 'Conservatory', 'Ballroom', 'Kitchen'];
        rooms.forEach(roomId => {
            const charElement = document.getElementById(`${roomId}-characters`);
            if (charElement) {
                const previousContent = charElement.innerHTML;
                const charactersInRoom = players
                    .filter(player => player.location === roomId)
                    .map(player => {
                        const isCurrentPlayer = player.username === currentUsername;
                        const isMoved = player.username === movedPlayer;
                        const baseClass = isCurrentPlayer ? 'player-me' : 'player-other';  // Red for me, Blue for others
                        const className = isMoved ? `${baseClass} pulse-move` : baseClass;
                        return `<span class="${className}">${player.character}</span>`;
                    })
                    .join('');

                // Update content and remove animation class after it runs
                if (previousContent !== charactersInRoom) {
                    charElement.innerHTML = charactersInRoom || '';
                    setTimeout(() => {
                        const spans = charElement.querySelectorAll('.pulse-move');
                        spans.forEach(span => span.classList.remove('pulse-move'));
                    }, 500); // Match animation duration
                } else {
                    charElement.innerHTML = charactersInRoom || '';
                }
                console.log(`Updated ${roomId} characters: ${charactersInRoom}`); // Debug log
            }
        });
    }

    // Update hallway characters with animation only for the moved player,
    // showing all players regardless of is_active
    function updateHallwayCharacters(players, movedPlayer) {
        const hallways = ['Hallway1', 'Hallway2',
                            'Hallway3', 'Hallway4', 'Hallway5',
                            'Hallway6', 'Hallway7',
                            'Hallway8', 'Hallway9', 'Hallway10',
                            'Hallway11', 'Hallway12'];
        hallways.forEach(hallwayId => {
            const charElement = document.getElementById(`${hallwayId}-characters`);
            if (charElement) {
                const previousContent = charElement.innerHTML;
                const charactersInHallway = players
                    .filter(player => player.location === hallwayId)
                    .map(player => {
                        const isCurrentPlayer = player.username === currentUsername;
                        const isMoved = player.username === movedPlayer;
                        const baseClass = isCurrentPlayer ? 'player-me' : 'player-other';
                        const className = isMoved ? `${baseClass} pulse-move` : baseClass;
                        return `<span class="${className}">${player.character}</span>`;
                    })
                    .join('');

                // Update content and remove animation class after it runs
                if (previousContent !== charactersInHallway) {
                    charElement.innerHTML = charactersInHallway || '';
                    setTimeout(() => {
                        const spans = charElement.querySelectorAll('.pulse-move');
                        spans.forEach(span => span.classList.remove('pulse-move'));
                    }, 500); // Match animation duration
                } else {
                    charElement.innerHTML = charactersInHallway || '';
                }
                console.log(`Updated ${hallwayId} characters: ${charactersInHallway}`);
            }
        });
    }

    // Add click event listeners to rooms and hallways for player movement
    function addClickListeners() {
        const rooms = document.querySelectorAll('.room'); // Select all room elements
        const hallways = document.querySelectorAll('.hallway'); // Select all hallway elements
        const clickableElements = [...rooms, ...hallways]; // Combine into a single array

        clickableElements.forEach(element => {
            element.addEventListener('click', () => {
                const location = element.id;
                const message = JSON.stringify({
                    'type': 'move',
                    'location': location
                });
                console.log('Sending move:', message);
                ws.send(message);
            });
        });
    }

    // Initialize the game board when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Initial players data:', playersData); // Debug log for initial data
        updateGameBoard({ players: playersData }); // Initial update with server-rendered data
        addClickListeners(); // Set up click events for movement
    });
    </script>
</body>
</html>